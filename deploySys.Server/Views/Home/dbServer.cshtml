@{
    Layout = "_dataLayout";
}

@section _search {
    <searchEditor v-bind:SearchModel="mainSearchModel" v-on:dosearch="getMainTableData"></searchEditor>
}
@section _command{
    <el-button-group>
        <el-button type="primary" icon="el-icon-edit" v-on:click="mainEdit" :disabled="mainCommandDisnable"></el-button>
        <el-button type="primary" icon="el-icon-circle-plus" v-on:click="mainAdd" ></el-button>
        <el-button type="primary" icon="el-icon-delete" v-on:click="mainDelete" :disabled="mainCommandDisnable"></el-button>
        <el-button type="primary" icon="el-icon-s-tools" v-on:click="openDbInstance" :disabled="mainCommandDisnable">查看数据库</el-button>
       
    </el-button-group>
}

<template>
    <div>
        <v-table is-vertical-resize
                 :vertical-resize-offset='60'
                 is-horizontal-resize
                 style="width:100%"
                 :multiple-sort="false"
                 :min-height="550"
                 even-bg-color="#f2f2f2"
                 :columns="mainTableConfig.columns"
                 :table-data="mainTableConfig.tableData"
                 row-hover-color="#eee"
                 row-click-color="#edf7ff"
                 :row-click="mainRowClick"
                 v-on:sort-change="sortChange"
                 :paging-index="(mainPageIndex-1)*pageSize">

        </v-table>

        <div class="mt20 mb20 bold"></div>

        <div class="pages">
            <v-pagination v-on:page-change="mainPageChange" v-on:page-size-change="mainPageSizeChange" :total="mainTotalCount" :page-size="pageSize" :layout="['total', 'prev', 'pager', 'next', 'sizer', 'jumper']">

            </v-pagination>
        </div>
    </div>
    <div>
        @Html.Partial("dbServer_js")
    </div>
</template>


@section vueScript{
    <script>
        var vmd = new ViewModel();
        vmd.init("#app");
        function ViewModel() {
            var me = this;
            ViewModelBase.call(me);
            vmExtend.call(me);
            me.data.deptOptions = [];
            me.data.rolesOptions = [{Id:0,Name:"mysql"},{Id:1,Name:"sqlite"},{Id:2,Name:"sqlserver"},{Id:3,Name:"oracle"},{Id:4,Name:"pgsql"}];
            me.data.mainTableConfig.columns = [
                {
                    field: 'Id', width: 80, titleAlign: 'center', columnAlign: 'center', title: 'ID', titleCellClassName: 'title-cell-class-name-title', isFrozen:true
                },
                { field: 'Name', width: 120, titleAlign: 'center', title: '名称', columnAlign: 'center', titleCellClassName: 'title-cell-class-name-title',isResize: true},
                { field: 'dbType', width: 120, titleAlign: 'center', title: '数据库类型', columnAlign: 'center', titleCellClassName: 'title-cell-class-name-title',isResize: true },
                { field: 'IP', width: 120, titleAlign: 'center', title: 'Ip地址', columnAlign: 'center', titleCellClassName: 'title-cell-class-name-title',isResize: true },

                { field: 'Port', width: 200, titleAlign: 'center', title: '端口号', columnAlign: 'center', titleCellClassName: 'title-cell-class-name-title', isResize: true },
                { field: 'rootUser', width: 200, titleAlign: 'center', title: 'root用户', columnAlign: 'center', titleCellClassName: 'title-cell-class-name-title', isResize: true },


            ];

        }
        function vmExtend() {
            var me = this;

            me.methods.sortChange = function (params) {
                if (params.height.length > 0) {

                    this.mainTableConfig.tableData.sort(function (a, b) {

                        if (params.height === 'asc') {

                            return a.height - b.height;
                        } else if (params.height === 'desc') {

                            return b.height - a.height;
                        } else {

                            return 0;
                        }
                    });
                }

            };
            me.mainLoadTablePagedDataUrl = "/Api/SysConf/DbServers";
            me.mainAddUrl = "/Api/SysConf/auDbServer";
            me.mainDeleteUrl = "/Api/SysConf/deleteDbServer";
            me.mainUpdateUrl = "/Api/SysConf/auDbServer";
            me.data.mainDialog = new userDialog(this, true);
            me.mainDetailUrl = " ";
           
            me.methods.mainAdd = function () {
                var newmodel = { Id: -1, allroles: [],Password:"" };
                me.OnMainEdit(newmodel, "新增");
            };
              me.methods.openDbInstance = function () {
                var xx = top.layui.element;
                var tabUrl = "/home/DbInstance/" + me.data.mainSelectedModel.Id;
                var tabDDid = "DbInstance-" + me.data.mainSelectedModel.Id;
                var tabTitle = "数据库[" + me.data.mainSelectedModel.Name + "]";
                $vmpa.addOrChangeToTab(tabUrl, tabDDid, tabTitle);
            }
        }
        function userDialog(vm, _ismain) {
            var me = this;
            DialogBase.call(me, vm, _ismain);
            me.AesEncrypt = function (source, key) {
                var key = CryptoJS.enc.Utf8.parse(key);//32位
                var iv = CryptoJS.enc.Utf8.parse("@ViewBag.AesIV");//16位
                var srcs = CryptoJS.enc.Utf8.parse(source);
                var encrypted = CryptoJS.AES.encrypt(srcs, key, {
                    iv: iv,
                    mode: CryptoJS.mode.CBC,
                    padding: CryptoJS.pad.Pkcs7
                });
                return encrypted.ciphertext.toString();
            };
            me.OnSave = function (model) {
                var updateurl = "";
                if (me.EditModel["Password"] != null) {
                    me.EditModel["rootPassword"] = me.AesEncrypt(me.EditModel["Password"], "@ViewBag.AesKey")
                }
                if (me.EditModel[me._vm.ModelKeyName] > 0) {


                    if (me.isMain)
                        updateurl = me._vm.mainUpdateUrl;
                    else
                        updateurl = me._vm.slaveUpdateUrl;
                    var ret = $vmpa.postSync(updateurl, me.EditModel, function (result) {

                    });
                     return ret.responseJSON.Status;
                } else {
                    if (me.isMain)
                        updateurl = me._vm.mainAddUrl;
                    else
                        updateurl = me._vm.slaveAddUrl;
                    var ret = $vmpa.postSync(updateurl, me.EditModel, function (result) {

                    });
                     return ret.responseJSON.Status;
                }
            }
        
           
        }
    </script>

}

